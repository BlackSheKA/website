<html>
<!-- Chatbase Chat Bubble -->
<!-- Chat Bubble Embed -->
<!-- Chat Bubble Embed -->
<div id="chat-bubble-container"></div>
<script>
  (function() {
    // Configuration
    const config = {
      chatbotId: "your-agent-id",
      domain: "1d4ddf87-895a-4048-bd28-063cc947581c.canvases.tempo.build",
      theme: "light",
      userMessageColor: "#3B81F6",
      bubbleButtonColor: "#000000",
      alignment: "right",
      apiUrl: "https://uqcaakndeekmpthpluel.supabase.co",
      apiKey: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InVxY2Fha25kZWVrbXB0aHBsdWVsIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTM0NTIxMjUsImV4cCI6MjA2OTAyODEyNX0.MH9s2EmdRtFkTd915UneF0Gm01JZqSvXUg6zL_7l97Q"
    };

    let currentConversationId = null;
    let sessionId = 'session_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);

    // Supabase client setup
    const supabaseUrl = config.apiUrl;
    const supabaseKey = config.apiKey;
    
    // Simple fetch-based Supabase client
    const supabaseClient = {
      from: (table) => ({
        insert: async (data) => {
          const response = await fetch(`${supabaseUrl}/rest/v1/${table}`, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'apikey': supabaseKey,
              'Authorization': `Bearer ${supabaseKey}`,
              'Prefer': 'return=representation'
            },
            body: JSON.stringify(data)
          });
          return await response.json();
        },
        update: async (data) => ({
          eq: (column, value) => ({
            execute: async () => {
              const response = await fetch(`${supabaseUrl}/rest/v1/${table}?${column}=eq.${value}`, {
                method: 'PATCH',
                headers: {
                  'Content-Type': 'application/json',
                  'apikey': supabaseKey,
                  'Authorization': `Bearer ${supabaseKey}`
                },
                body: JSON.stringify(data)
              });
              return await response.json();
            }
          })
        })
      })
    };

    // Create new conversation
    const createConversation = async () => {
      try {
        const conversationData = {
          agent_id: config.chatbotId,
          session_id: sessionId,
          status: 'active',
          started_at: new Date().toISOString(),
          message_count: 0
        };
        
        const result = await supabaseClient.from('conversations').insert(conversationData);
        if (result && result.length > 0) {
          currentConversationId = result[0].id;
        }
      } catch (error) {
        console.error('Error creating conversation:', error);
      }
    };

    // Save message to database
    const saveMessage = async (role, content) => {
      if (!currentConversationId) return;
      
      try {
        const messageData = {
          conversation_id: currentConversationId,
          role: role,
          content: content,
          timestamp: new Date().toISOString()
        };
        
        await supabaseClient.from('messages').insert(messageData);
        
        // Update conversation message count
        await supabaseClient.from('conversations')
          .update({ 
            message_count: document.querySelectorAll('#chat-messages > div').length,
            updated_at: new Date().toISOString()
          })
          .eq('id', currentConversationId)
          .execute();
      } catch (error) {
        console.error('Error saving message:', error);
      }
    };

    // End conversation
    const endConversation = async () => {
      if (!currentConversationId) return;
      
      try {
        const startTime = new Date(sessionStartTime);
        const endTime = new Date();
        const duration = Math.floor((endTime - startTime) / 1000);
        
        await supabaseClient.from('conversations')
          .update({
            status: 'ended',
            ended_at: endTime.toISOString(),
            duration: duration,
            evaluation_result: 'Successful'
          })
          .eq('id', currentConversationId)
          .execute();
      } catch (error) {
        console.error('Error ending conversation:', error);
      }
    };

    let sessionStartTime = Date.now();

    // Create chat bubble HTML
    const createChatBubble = () => {
      const bubbleHtml = `
        <div id="chat-bubble" style="
          position: fixed;
          bottom: 20px;
          ${config.alignment === 'left' ? 'left: 20px;' : 'right: 20px;'}
          width: 60px;
          height: 60px;
          background-color: ${config.bubbleButtonColor};
          border-radius: 50%;
          cursor: pointer;
          box-shadow: 0 4px 12px rgba(0,0,0,0.15);
          display: flex;
          align-items: center;
          justify-content: center;
          z-index: 9999;
          transition: all 0.3s ease;
        " onclick="toggleChat()">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2">
            <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/>
          </svg>
        </div>
        
        <div id="chat-window" style="
          position: fixed;
          bottom: 90px;
          ${config.alignment === 'left' ? 'left: 20px;' : 'right: 20px;'}
          width: 350px;
          height: 500px;
          background: white;
          border-radius: 12px;
          box-shadow: 0 8px 32px rgba(0,0,0,0.12);
          display: none;
          flex-direction: column;
          z-index: 9998;
          font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        ">
          <div style="
            background: ${config.userMessageColor};
            color: white;
            padding: 16px;
            border-radius: 12px 12px 0 0;
            display: flex;
            align-items: center;
            gap: 12px;
          ">
            <div style="
              width: 32px;
              height: 32px;
              background: rgba(255,255,255,0.2);
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              font-weight: bold;
            ">A</div>
            <span style="font-weight: 500;">Assistant</span>
            <button onclick="closeChat()" style="
              margin-left: auto;
              background: none;
              border: none;
              color: white;
              cursor: pointer;
              font-size: 18px;
            ">Ã—</button>
          </div>
          
          <div id="chat-messages" style="
            flex: 1;
            padding: 16px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 12px;
          ">
            <div style="
              background: #f1f5f9;
              padding: 12px;
              border-radius: 12px;
              max-width: 80%;
            ">
              Hi! What can I help you with?
            </div>
          </div>
          
          <div style="
            padding: 16px;
            border-top: 1px solid #e2e8f0;
          ">
            <div style="display: flex; gap: 8px;">
              <input 
                id="chat-input" 
                type="text" 
                placeholder="Message..."
                style="
                  flex: 1;
                  padding: 12px;
                  border: 1px solid #e2e8f0;
                  border-radius: 8px;
                  outline: none;
                  font-size: 14px;
                "
                onkeypress="if(event.key==='Enter') sendMessage()"
              />
              <button onclick="sendMessage()" style="
                background: ${config.userMessageColor};
                color: white;
                border: none;
                padding: 12px 16px;
                border-radius: 8px;
                cursor: pointer;
                font-weight: 500;
              ">Send</button>
            </div>
          </div>
        </div>
      `;
      
      document.getElementById('chat-bubble-container').innerHTML = bubbleHtml;
    };

    // Toggle chat window
    window.toggleChat = async () => {
      const chatWindow = document.getElementById('chat-window');
      const isVisible = chatWindow.style.display === 'flex';
      
      if (!isVisible && !currentConversationId) {
        await createConversation();
        sessionStartTime = Date.now();
      }
      
      chatWindow.style.display = isVisible ? 'none' : 'flex';
    };

    // Close chat and end conversation
    window.closeChat = async () => {
      const chatWindow = document.getElementById('chat-window');
      chatWindow.style.display = 'none';
      
      if (currentConversationId) {
        await endConversation();
        currentConversationId = null;
      }
    };

    // Send message function
    window.sendMessage = async () => {
      const input = document.getElementById('chat-input');
      const message = input.value.trim();
      if (!message) return;

      const messagesContainer = document.getElementById('chat-messages');
      
      // Add user message
      const userMessage = document.createElement('div');
      userMessage.style.cssText = `
        background: ${config.userMessageColor};
        color: white;
        padding: 12px;
        border-radius: 12px;
        max-width: 80%;
        margin-left: auto;
        text-align: right;
      `;
      userMessage.textContent = message;
      messagesContainer.appendChild(userMessage);
      
      // Save user message
      await saveMessage('user', message);
      
      input.value = '';
      messagesContainer.scrollTop = messagesContainer.scrollHeight;

      // Simulate bot response
      setTimeout(async () => {
        const botResponse = "Thanks for your message! This is a demo response.";
        const botMessage = document.createElement('div');
        botMessage.style.cssText = `
          background: #f1f5f9;
          padding: 12px;
          border-radius: 12px;
          max-width: 80%;
        `;
        botMessage.textContent = botResponse;
        messagesContainer.appendChild(botMessage);
        messagesContainer.scrollTop = messagesContainer.scrollHeight;
        
        // Save bot message
        await saveMessage('assistant', botResponse);
      }, 1000);
    };

    // Initialize when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', createChatBubble);
    } else {
      createChatBubble();
    }
  })();
</script>
    
    before
    hello world!!!!!
</html>
